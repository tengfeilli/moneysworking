<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>每日宽度 + 期权结构观测首页</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0b0f14;
      --fg:#e5e7eb;
      --muted:#9ca3af;
      --card:#111827;
      --border:#263244;
      --shadow: 0 10px 24px rgba(0,0,0,.35);

      --link:#60a5fa;
      --linkHover:#93c5fd;

      --tagBg: rgba(96,165,250,.14);
      --tagFg:#93c5fd;

      --amber:#fbbf24;
    }

    html, body{ background: var(--bg); color: var(--fg); }
    body{
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      max-width: 960px;
      margin: 40px auto;
      padding: 0 16px;
      line-height: 1.6;
    }

    h1{ font-size: 26px; margin-bottom: 4px; color: var(--fg); }
    .subtitle{ color: var(--muted); margin-bottom: 24px; font-size: 14px; }

    section{
      margin-bottom: 28px;
      background: var(--card);
      padding: 18px 20px;
      border-radius: 12px;
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
    }

    h2{ font-size: 18px; margin-top: 0; margin-bottom: 8px; color: var(--fg); }

    ul{ list-style: none; padding-left: 0; margin: 8px 0 0; }
    li{ margin: 10px 0; display:flex; align-items:center; gap:10px; flex-wrap:wrap; }

    a{ color: var(--link); text-decoration: none; }
    a:hover{ color: var(--linkHover); text-decoration: underline; }

    .tag{
      display: inline-block;
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(96,165,250,.14);
      color: var(--tagFg);
      border: 1px solid rgba(96,165,250,.25);
      vertical-align: middle;
    }

    /* ===== 红绿灯（与 delta_wall_interactive 一致风格）===== */
    .status{
      display:inline-flex;
      align-items:center;
      gap:10px;
      margin-left: 4px;
      color: var(--muted);
      font-size: 12px;
    }
    .traffic{
      display:inline-flex;
      align-items:center;
      gap:8px;
      vertical-align: middle;
    }
    .light{
      width: 14px;
      height: 14px;
      border-radius: 50%;
      opacity: .22;
      border: 1px solid rgba(255,255,255,.18);
    }
    .light.on{ opacity: 1; box-shadow: 0 0 10px rgba(255,255,255,.10); }
    .light.red{ background:#ff3b30; }
    .light.green{ background:#34c759; }
    .light.amber{ background: var(--amber); } /* 可选：如果你以后想做“中性=黄” */

    footer{
      margin-top: 32px;
      font-size: 12px;
      color: var(--muted);
      text-align: center;
    }
  </style>
</head>

<body>
  <h1>每日宽度 + 指数期权结构 观测首页</h1>
  <div class="subtitle">
    数据来源：自建宽度与期权数据库 · 本页仅用于信息展示与教学，不构成任何投资建议。
    仅限订阅用户使用，未经许可禁止转载，或分享给他人。
  </div>

  <section>
    <h2>一、指数宽度观察</h2>
    <ul>
      <li>
        <a href="breadth_overview.html">宽度概览SP500 + NDX</a>
        <span class="tag">Breadth</span>
        <!-- ✅ 状态占位：breadth_status.json -->
        <span class="status" data-status-src="breadth_status.json">状态加载中…</span>
      </li>
    </ul>
  </section>

  <section>
    <h2>二、指数期权结构</h2>
    <ul>
      <li>
        <a href="options_overview_cn.html">美股指数期权概览</a>
        <span class="tag">IV + Skew</span>
        <!-- ✅ 状态占位：spx_risk_state.json -->
        <span class="status" data-status-src="spx_risk_state.json">状态加载中…</span>
      </li>
    </ul>
  </section>

  <section>
    <h2>三、交互墙</h2>
    <ul>
      <li>
        <a href="delta_wall_interactive.html">Delta Wall 交互版</a>
        <span class="tag">Interactive</span>
        <!-- ✅ 状态占位：delta_wall_status.json -->
        <span class="status" data-status-src="delta_wall_status.json">状态加载中…</span>
      </li>
    </ul>
  </section>

  <footer>
    本站基于 GitHub Pages 静态托管 · 仅展示每日宽度与期权结构快照 · 不构成任何投资建议。
  </footer>
<script>
  // 兜底：从中文状态文字推断（可选）
  function inferLightFromText(stateText){
    const s = String(stateText || "");
    if (/(风险|防守|偏空|看空|空头|红)/.test(s)) return "red";
    if (/(偏多|看多|多头|绿)/.test(s)) return "green";
    return "red"; // 不明确就偏保守
  }

  // 把各种可能的字段值，归一化成 "green"/"red"
  function normalizeLight(x){
    const s = String(x || "").toLowerCase();
    if (/green|偏多|看多|多头|绿/.test(s)) return "green";
    if (/red|风险|防守|偏空|看空|空头|红/.test(s)) return "red";
    return "";
  }

  // ✅ 核心：只要任何一个候选灯是 green => green；否则 red
  function pickLight(payload, fallbackStateCN){
    const candidates = [];

    // 1) 你现在已有的单灯字段
    if (payload.light) candidates.push(payload.light);

    // 2) Breadth 的双灯字段（建议你后端输出其中一种命名）
    if (payload.ma20_light) candidates.push(payload.ma20_light);
    if (payload.combo_light) candidates.push(payload.combo_light);
    if (payload.composite_light) candidates.push(payload.composite_light);

    // 3) 兼容 lights: ["red","green"] 或 lights: {ma20:"red", combo:"green"}
    if (payload.lights && Array.isArray(payload.lights)) candidates.push(...payload.lights);
    if (payload.lights && typeof payload.lights === "object") candidates.push(...Object.values(payload.lights));

    // 4) 如果你后端输出的是“文字状态”而不是 light，也能吃进来推断
    if (payload.ma20_state_cn) candidates.push(payload.ma20_state_cn);
    if (payload.combo_state_cn) candidates.push(payload.combo_state_cn);

    const lights = candidates.map(normalizeLight).filter(Boolean);

    if (lights.includes("green")) return "green";
    if (lights.includes("red")) return "red";

    // 最后兜底：用整体 stateCN 推断
    return inferLightFromText(fallbackStateCN);
  }

  function renderStatus(el, payload){
    const tradeDate = payload.trade_date || payload.tradeDate || "";
    const stateCN   = payload.market_state_cn || payload.state_cn || payload.state || "";
    const reasonCN  = payload.market_state_reason_cn || payload.reason_cn || "";

    const light = pickLight(payload, stateCN);

    const trafficHTML = `
      <span class="traffic" title="红=风险/防守；绿=偏多/稳（Breadth: 任意一灯绿 => 绿）">
        <span class="light red ${light==="red" ? "on" : ""}"></span>
        <span class="light green ${light==="green" ? "on" : ""}"></span>
      </span>
    `;

    const label = stateCN ? `状态：${stateCN}` : "状态：--";
    const dateLabel = tradeDate ? ` · ${tradeDate}` : "";
    const tip = reasonCN ? `\n${reasonCN}` : "";

    el.title = (label + dateLabel + tip).trim();
    el.innerHTML = `${trafficHTML}<span>${label}${dateLabel}</span>`;
  }

  async function loadOneStatus(el){
    const url = el.getAttribute("data-status-src");
    if (!url) return;

    try{
      // 防缓存：加时间戳（GitHub Pages/CDN 更稳）
      const res = await fetch(`${url}?t=${Date.now()}`, { cache: "no-store" });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const payload = await res.json();
      renderStatus(el, payload || {});
    }catch(e){
      el.textContent = "状态：暂不可用";
      el.title = `加载失败：${String(e)}`;
    }
  }

  document.addEventListener("DOMContentLoaded", function(){
    document.querySelectorAll(".status[data-status-src]").forEach(loadOneStatus);
  });
</script>

</body>
</html>
